<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>لغز 1: سرقة البنك</title>
  <style>
    body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: linear-gradient(135deg, #1e3c72, #2a5298); margin: 0; padding: 0; color: #fff; }
    .header { text-align: center; padding: 20px; background: #1a2a44; border-bottom: 2px solid #2a5298; }
    .header h1 { margin: 0; font-size: 2em; color: #f0f0f0; text-shadow: 1px 1px 5px #000; }
    .container { max-width: 800px; margin: 20px auto; padding: 20px; background: rgba(26, 42, 68, 0.9); border-radius: 10px; box-shadow: 0 0 15px rgba(0, 0, 0, 0.5); }
    .puzzle-area { text-align: center; }
    .hack-interface { position: relative; width: 700px; height: 400px; margin: 20px auto; background: #1a2a44; border: 2px solid #2a5298; border-radius: 10px; overflow: hidden; }
    .hack-line { position: absolute; width: 40px; height: 40px; background: #3e6cb7; border-radius: 5px; transition: top 0.1s, background 0.2s; }
    .hack-line.active { background: #28a745; }
    .hack-line.fail { background: #ff4444; }
    .controls { margin: 10px 0; }
    .btn { padding: 10px 20px; margin: 5px; border: none; cursor: pointer; background: #007BFF; color: #fff; border-radius: 5px; transition: background 0.3s; }
    .btn:hover { background: #0056b3; }
    .btn:disabled { background: #6c757d; cursor: not-allowed; }
    .hint { color: #ccc; font-style: italic; margin: 10px 0; }
    .code-entry { text-align: center; margin-top: 20px; }
    .nav-actions { text-align: center; margin-top: 20px; }
    .success { background: #28a745; }
    .success:hover { background: #218838; }
    .message { color: #ff4444; }
    .footer { text-align: center; padding: 10px; background: #1a2a44; position: fixed; bottom: 0; width: 100%; color: #ccc; }
  </style>
</head>
<body>
  <header class="header">
    <h1>لغز 1: سرقة البنك</h1>
    <p>قم باختراق نظام الأمان لفتح الباب!</p>
  </header>

  <main class="container">
    <section class="puzzle-area">
      <div class="hack-interface" id="hackInterface"></div>
      <div class="controls">
        <button id="btnHack" class="btn" onclick="startHack()">ابدأ الاختراق</button>
        <button id="btnAbort" class="btn" onclick="abortHack()" disabled>ألغِ الاختراق</button>
      </div>
      <p id="status" class="hint">اضغط على "ابدأ الاختراق" لتبدأ، واستخدم ~INPUT_FRONTEND_CANCEL~ (Esc) للمتابعة أو الإلغاء.</p>
    </section>

    <section class="code-entry">
      <label for="puzzle1-code">أدخل الرمز:</label>
      <input id="puzzle1-code" type="text" placeholder="اكتب الرمز هنا" autocomplete="off" style="display:none;">
      <button id="btn-verify-code" class="btn" style="display:none;" onclick="verifyCode()">تحقق</button>
      <p id="verify-message" class="message"></p>
    </section>

    <section class="nav-actions">
      <button id="btn-next" class="btn success" style="display:none;" onclick="window.location.href='puzzle-2-cipher.html'">التالي</button>
      <button id="btn-back-home" class="btn" onclick="window.location.href='index.html'">العودة للرئيسية</button>
    </section>
  </main>

  <footer class="footer">
    <small>© 2025 ألغاز الفلوقا سلوكا - بالتوفيق! 🍀</small>
  </footer>

  <script>
    let stophack = false;
    let Dat_1 = [
      { val1: 0.4 }, { val1: 0.4 }, { val1: 0.4 },
      { val1: 0.4 }, { val1: 0.4 }, { val1: 0.4 },
      { val1: 0.4 }
    ];
    let Dat_2 = [
      { val0: 1, val1: 0.02 * 0.55, val2: 0, val3: 1, val4: true },
      { val0: 1, val1: 0.025 * 0.55, val2: 0, val3: 1, val4: true },
      { val0: 1, val1: 0.03 * 0.55, val2: 0, val3: 1, val4: true },
      { val0: 1, val1: 0.035 * 0.55, val2: 0, val3: 1, val4: true },
      { val0: 1, val1: 0.04 * 0.55, val2: 0, val3: 1, val4: true },
      { val0: 1, val1: 0.045 * 0.55, val2: 0, val3: 1, val4: true },
      { val0: 1, val1: 0.05 * 0.55, val2: 0, val3: 1, val4: true }
    ];
    let current = 1;
    let gameLoop;

    function cosDegrees(degrees) {
      return Math.cos(degrees * Math.PI / 180);
    }

    function interpolate(val1, val2, progress) {
      return val1 * (1 - progress) + val2 * progress;
    }

    function isInRange(value) {
      return value >= 0.51 && value <= 0.62;
    }

    function startHack() {
      stophack = false;
      document.getElementById('btnHack').disabled = true;
      document.getElementById('btnAbort').disabled = false;
      document.getElementById('status').textContent = 'اضغط Esc للمتابعة أو الإلغاء.';
      initHackInterface();
      gameLoop = setInterval(updateHack, 16); // ~60 FPS
      hackInput();
    }

    function initHackInterface() {
      const interface = document.getElementById('hackInterface');
      interface.innerHTML = '';
      for (let i = 1; i <= 7; i++) {
        const line = document.createElement('div');
        line.className = 'hack-line';
        line.style.left = `${30 + (i - 1) * 10}%`;
        line.style.top = `${Dat_1[i - 1].val1 * 100}%`;
        interface.appendChild(line);
      }
    }

    function updateHack() {
      if (stophack) return;
      for (let i = 0; i < Dat_2.length; i++) {
        if (Dat_2[i].val3 === 1) {
          if (Dat_2[i].val2 < 1.0) {
            Dat_2[i].val2 += Dat_2[i].val1 * (0.016 * 25); // Timestep approximation
          } else {
            Dat_2[i].val3 = 0;
          }
        } else if (Dat_2[i].val2 > 0.0) {
          Dat_2[i].val2 -= Dat_2[i].val1 * (0.016 * 25);
        } else {
          Dat_2[i].val3 = 1;
        }
        if (Dat_2[i].val0 === 0 || Dat_2[i].val4) {
          Dat_1[i].val1 = interpolate(0.744, 0.4, Dat_2[i].val2);
        }
        const line = document.getElementById('hackInterface').children[i];
        line.style.top = `${Dat_1[i].val1 * 100}%`;
        if (Dat_2[i].val0 === 0) line.classList.add('active');
        else line.classList.remove('active');
      }
    }

    function hackInput() {
      document.addEventListener('keydown', (e) => {
        if (stophack) return;
        if (e.key === 'Escape') {
          if (isInRange(Dat_1[current - 1].val1)) {
            playSound('success');
            Dat_2[current - 1].val0 = 1;
            Dat_2[current - 1].val4 = false;
            Dat_1[current - 1].val1 = 0.572;
            if (current < 7) Dat_2[current].val0 = 0;
            current++;
            if (current > 7) {
              clearInterval(gameLoop);
              showCodeInput();
              document.getElementById('puzzle1-code').value = 'B1-HACK';
              document.getElementById('btn-verify-code').click();
            }
          } else {
            playSound('fail');
            if (current > 1) {
              Dat_2[current - 1].val0 = 1;
              current--;
              Dat_2[current - 1].val0 = 0;
              Dat_1[current - 1].val1 = 0.572;
              Dat_2[current - 1].val4 = true;
            }
          }
        }
      });
    }

    function abortHack() {
      stophack = true;
      clearInterval(gameLoop);
      document.getElementById('btnHack').disabled = false;
      document.getElementById('btnAbort').disabled = true;
      document.getElementById('status').textContent = 'تم إلغاء الاختراق، جرب مرة أخرى.';
    }

    function playSound(type) {
      const audio = new Audio(type === 'success' ? 'https://www.soundjay.com/buttons/beep-01a.mp3' : 'https://www.soundjay.com/buttons/beep-03.mp3');
      audio.play();
    }

    function showCodeInput() {
      document.getElementById('puzzle1-code').style.display = 'inline-block';
      document.getElementById('btn-verify-code').style.display = 'inline-block';
    }

    async function verifyCode() {
      const userCode = document.getElementById('puzzle1-code').value.trim();
      if (userCode === 'B1-HACK') {
        document.getElementById('verify-message').textContent = 'مبروك! الباب مفتوح، انتقل للغز التالي.';
        document.getElementById('btn-next').style.display = 'inline-block';
        localStorage.setItem('progress', 'puzzle-2-cipher.html');
      } else {
        document.getElementById('verify-message').textContent = 'الرمز غير صحيح، حاول مرة أخرى.';
      }
    }
  </script>
</body>
</html>
